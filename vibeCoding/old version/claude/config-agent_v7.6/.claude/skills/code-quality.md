# Code Quality (代码质量)

> 合并：代码简化 + 错误学习 + 调试

---

## 1. 代码简化原则

### 硬性指标
| 指标 | 限制 |
|:---|:---|
| 函数行数 | < 50 行 |
| 嵌套深度 | < 3 层 |
| 参数数量 | < 5 个 |
| 圈复杂度 | < 10 |

### Linus 品味清单
```
每次写代码前问自己：
- [ ] 能删吗？（最好的代码是不存在的代码）
- [ ] 能合并吗？（减少重复）
- [ ] 能简化吗？（去掉不必要的抽象）
- [ ] 好读吗？（下次看能秒懂吗）
- [ ] 好改吗？（改一处会影响几处）
```

### 重构技巧
```typescript
// ❌ 嵌套过深
if (a) {
  if (b) {
    if (c) {
      doSomething()
    }
  }
}

// ✅ 提前返回
if (!a) return
if (!b) return
if (!c) return
doSomething()

// ❌ 参数过多
function create(name, age, email, phone, address, city) {}

// ✅ 对象参数
function create(user: UserInput) {}
```

---

## 2. 错误学习

### 错误分类
| 类型 | 示例 |
|:---|:---|
| 空值错误 | undefined is not an object |
| 异步错误 | Unhandled Promise rejection |
| 类型错误 | Cannot read property of null |
| 边界错误 | Index out of bounds |

### 学习流程
```
发现错误 → 分析原因（5 Why）→ 修复 → 验证 → 记录教训
```

### 5 Why 示例
```
错误: 用户登录失败
Why 1: API 返回 401
Why 2: Token 过期
Why 3: Token 刷新失败
Why 4: 刷新接口没有错误处理
Why 5: 缺少统一的错误处理机制
→ 根因: 架构问题
→ 教训: 需要统一的错误处理中间件
```

### 自动记录
```javascript
// 修复 Bug 后自动执行
await memory.add({
  category: "lesson_learned",
  content: "异步操作需要 try-catch 包裹",
  tags: ["async", "error_handling"]
})
```

---

## 3. 调试方法

### 调试流程
```
复现 → 隔离 → 定位 → 分析 → 修复 → 验证 → 总结
```

### 二分查找法
```
1. 确定问题范围
2. 在中间点设置断点/日志
3. 判断问题在前半还是后半
4. 重复直到定位到具体行
```

### 橡皮鸭调试法
```
向橡皮鸭（或 AI）解释你的代码：
1. 这段代码要做什么？
2. 输入是什么？
3. 输出应该是什么？
4. 实际输出是什么？
5. 差异在哪里？
```

### 调试检查清单
```
- [ ] 能稳定复现问题吗？
- [ ] 输入数据正确吗？
- [ ] 中间状态正确吗？
- [ ] 有错误日志吗？
- [ ] 最近改了什么？
```

---

## 4. 代码检查清单

### 执行前
```
- [ ] 函数 < 50 行
- [ ] 嵌套 < 3 层
- [ ] 无 any 类型
- [ ] 有错误处理
- [ ] 有输入验证
```

### 执行后
```
- [ ] 编译通过
- [ ] 测试通过
- [ ] 无新增警告
- [ ] 符合项目约定
```
