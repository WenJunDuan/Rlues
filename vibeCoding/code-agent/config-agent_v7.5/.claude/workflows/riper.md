# RIPER-10 执行循环 (v7.5 Enhanced)

> **核心改进**: 每个阶段细化具体步骤，强制 TODO 生成和核对

---

## 🔄 完整流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         RIPER-10 Flow                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│  │   R1    │─▶│    I    │─▶│    P    │─▶│    E    │─▶│   R2    │  │
│  │ RESEARCH│  │INNOVATE │  │  PLAN   │  │ EXECUTE │  │ REVIEW  │  │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │
│                                                                     │
│  感知理解      设计方案      生成TODO     执行开发      核对验收    │
│  ─────────    ─────────    ─────────    ─────────    ─────────    │
│  • 读状态      • 数据优先    • 任务拆解    • 逐项执行    • TODO核对  │
│  • 搜代码      • 方案对比    • 依赖排序    • 代码简化    • 验证测试  │
│  • 澄清疑点    • Linus审查   • 预估时间    • 验证回路    • 寸止确认  │
│                                                                     │
│  PDM          AR           PM           LD           QE            │
│  sou          thinking     meeting      引擎选择     verification  │
│               寸止          寸止                     寸止           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## R1 - RESEARCH (感知理解)

### 目标
深入理解需求和现有代码上下文，为后续阶段打下基础。

### 主导角色
PDM (产品经理)

### 详细步骤

```
┌─────────────────────────────────────────────────────────────┐
│                    R1 详细步骤                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 1.1: 状态恢复                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 读取 project_document/.ai_state/active_context.md │   │
│  │ • 读取 orchestrator.yaml 配置                       │   │
│  │ • 检查是否有未完成任务                               │   │
│  │ • 如有，汇报当前状态                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 1.2: 加载记忆                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • memory.recall({ category: "user_preference" })    │   │
│  │ • memory.recall({ category: "forbidden_action" })   │   │
│  │ • memory.recall({ category: "code_pattern" })       │   │
│  │ • 应用到当前会话                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 1.3: 代码搜索                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • sou.search("[关键词]")  // 语义搜索               │   │
│  │ • 仅读取直接相关文件                                 │   │
│  │ • 不要读取整个项目                                   │   │
│  │ • 识别现有模式和约定                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 1.4: 需求澄清                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 如果需求模糊：                                       │   │
│  │ • 使用寸止协议暂停                                   │   │
│  │ • 列出具体问题                                       │   │
│  │ • 等待用户回答                                       │   │
│  │                                                      │   │
│  │ 禁止猜测！不确定就问！                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 输出
- 需求理解摘要
- 相关代码位置
- 澄清后的需求（如有歧义）

### 工具
- `sou` (augment) — 语义代码搜索
- `memory` — 加载用户偏好和禁忌
- `寸止` — 需求澄清

---

## I - INNOVATE (设计方案)

### 目标
设计技术方案，遵循 Data First 原则。

### 主导角色
AR (架构师)

### 详细步骤

```
┌─────────────────────────────────────────────────────────────┐
│                     I 详细步骤                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 2.1: 问题分解（第一性原理）                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 这个需求的本质是什么？                             │   │
│  │ • 去掉所有假设后，还剩什么？                         │   │
│  │ • 最简方案是什么？                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 2.2: 数据结构设计 (Data First)                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 先定义 interface/type                             │   │
│  │ • 不要先写逻辑                                       │   │
│  │ • 问自己：这是最简的结构吗？                         │   │
│  │                                                      │   │
│  │ interface User {                                     │   │
│  │   id: string;                                        │   │
│  │   email: string;                                     │   │
│  │ }                                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 2.3: 方案对比                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 生成 2-3 个方案：                                    │   │
│  │                                                      │   │
│  │ | 维度 | 方案A | 方案B |                            │   │
│  │ |------|-------|-------|                            │   │
│  │ | 复杂度 | 低 | 中 |                                │   │
│  │ | 性能 | 高 | 中 |                                  │   │
│  │ | Linus评分 | 4/5 | 3/5 |                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 2.4: Linus 审查                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 自检清单：                                           │   │
│  │ - [ ] Data First: 数据结构最简？                    │   │
│  │ - [ ] Naming: 命名准确？                            │   │
│  │ - [ ] Simplicity: 无过度设计？                      │   │
│  │ - [ ] Taste: 设计有品味？                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 2.5: 寸止 - 设计确认（Path B/C）                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [DESIGN_FREEZE]                                     │   │
│  │ 推荐方案A，理由是...                                │   │
│  │ 请选择：A / B / 讨论                                │   │
│  │                                                      │   │
│  │ ⚠️ 禁止自作主张！                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 输出
- 数据结构定义
- 方案对比表
- 推荐方案及理由

### 工具
- `thinking` (sequential-thinking) — 深度推理
- `寸止` — 方案选择

### 跳过条件
- Path A 可跳过此阶段

---

## P - PLAN (生成TODO)

### 目标
将设计转化为可执行的 TODO 列表。

### 主导角色
PM (项目经理)

### 详细步骤

```
┌─────────────────────────────────────────────────────────────┐
│                     P 详细步骤                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 3.1: 任务分解                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 原则：                                               │   │
│  │ • MECE原则（互斥穷尽）                              │   │
│  │ • 任务粒度 < 4小时                                   │   │
│  │ • 每个任务有明确验收标准                             │   │
│  │ • 识别依赖关系                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 3.2: 生成 TODO 列表                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## TODO                                              │   │
│  │                                                      │   │
│  │ - [ ] T-001: [任务描述]                              │   │
│  │   - **文件**: [涉及文件]                            │   │
│  │   - **依赖**: 无                                    │   │
│  │   - **预估**: 30分钟                                │   │
│  │   - **验收**: [验收标准]                            │   │
│  │   - **Owner**: LD                                   │   │
│  │                                                      │   │
│  │ - [ ] T-002: [任务描述]                              │   │
│  │   - **文件**: [涉及文件]                            │   │
│  │   - **依赖**: T-001                                 │   │
│  │   - **预估**: 1小时                                 │   │
│  │   - **验收**: [验收标准]                            │   │
│  │   - **Owner**: LD                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 3.3: 依赖排序                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 生成执行顺序：                                       │   │
│  │ T-001 → T-002 → T-003                               │   │
│  │     ↘           ↗                                   │   │
│  │       T-004 ──┘                                     │   │
│  │                                                      │   │
│  │ 可并行: T-002 和 T-004（无依赖冲突）                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 3.4: 风险评估                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ | 风险 | 概率 | 影响 | 缓解措施 |                   │   │
│  │ |------|------|------|----------|                   │   │
│  │ | R1   | 中   | 高   | [措施]   |                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 3.5: 寸止 - 计划确认                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [PLAN_READY]                                        │   │
│  │                                                      │   │
│  │ 任务计划：                                          │   │
│  │ • 总任务: 4个                                       │   │
│  │ • 预估时间: 3小时                                   │   │
│  │ • 依赖链: T-001 → T-002 → T-003                    │   │
│  │                                                      │   │
│  │ 请确认：确认 / 修改 / 取消                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 输出
- TODO 列表（写入 active_context.md）
- 执行顺序
- 风险清单

### 工具
- `meeting` — 多角色会议（复杂项目）
- `寸止` — 计划确认

### 强制规则
- **所有路径都必须生成 TODO**（即使只有1项）

---

## E - EXECUTE (执行开发)

### 目标
逐项执行 TODO，遵循代码简化原则。

### 主导角色
LD (开发工程师)

### 详细步骤

```
┌─────────────────────────────────────────────────────────────┐
│                     E 详细步骤                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  For each TODO item:                                        │
│                                                             │
│  Step 4.1: 任务准备                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 读取任务详情                                       │   │
│  │ • 检查依赖是否完成                                   │   │
│  │ • 检查 forbidden_action（禁止动作）                 │   │
│  │ • 选择执行引擎（用户指定 > 配置 > 默认）            │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4.2: 加载技能                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 加载 code-simplifier（必须）                      │   │
│  │ • 加载指定引擎 skill（如 codex/gemini）             │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4.3: 执行代码                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 编写/修改代码时：                                    │   │
│  │ • 函数 < 50行                                        │   │
│  │ • 嵌套 < 3层                                         │   │
│  │ • 无 any 类型                                        │   │
│  │ • 完整错误处理                                       │   │
│  │ • 遵循 Linus 品味                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4.4: 验证回路                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │  Execute → Verify → Pass? ──Yes──▶ Done            │   │
│  │                       │                              │   │
│  │                       No                             │   │
│  │                       ↓                              │   │
│  │              Analyze → Fix → Retry                   │   │
│  │                              (max 3)                 │   │
│  │                               │                      │   │
│  │                               Fail                   │   │
│  │                               ↓                      │   │
│  │                    [VERIFICATION_FAILED]             │   │
│  │                         寸止                         │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4.5: 更新状态                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 标记任务完成                                       │   │
│  │ • 记录实际用时                                       │   │
│  │ • 记录修改的文件                                     │   │
│  │ • 更新 kanban.md                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4.6: 学习沉淀                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 如果发现好模式或教训：                               │   │
│  │ • memory.add({ category: "code_pattern", ... })     │   │
│  │ • memory.add({ category: "lesson_learned", ... })   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  End For                                                    │
│                                                             │
│  Path C: 每个 Phase 结束后                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [PHASE_DONE]                                        │   │
│  │ Phase X 完成，请确认：继续 / 问题 / 暂停            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 输出
- 完成的代码
- 更新的 TODO 状态
- 验证证据

### 工具
- `code-simplifier` — 代码简化（必须）
- `codex` / `gemini` — 执行引擎（可选）
- `verification` — 验证回路

### 寸止点
- `[VERIFICATION_FAILED]` — 验证失败3次
- `[PRE_COMMIT]` — 大规模修改前（Path C）
- `[PHASE_DONE]` — 阶段完成（Path C）

---

## R2 - REVIEW (核对验收)

### 目标
根据 TODO 逐项核对，与用户确认。

### 主导角色
QE (质量工程师)

### 详细步骤

```
┌─────────────────────────────────────────────────────────────┐
│                    R2 详细步骤                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 5.1: TODO 逐项核对                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## TODO 核对                                         │   │
│  │                                                      │   │
│  │ - [x] T-001: 数据模型 ✅                             │   │
│  │   - **实际文件**: src/types/user.ts (+25/-0)        │   │
│  │   - **实际用时**: 20分钟 (预估: 30分钟)             │   │
│  │   - **验证结果**: TypeScript 编译通过               │   │
│  │                                                      │   │
│  │ - [x] T-002: API接口 ✅                              │   │
│  │   - **实际文件**: src/api/user.ts (+50/-0)          │   │
│  │   - **实际用时**: 45分钟 (预估: 1小时)              │   │
│  │   - **验证结果**: 接口测试通过                      │   │
│  │                                                      │   │
│  │ 总计: 2/2 完成 (100%)                               │   │
│  │ 总用时: 65分钟 (预估: 90分钟)                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 5.2: 验收标准检查                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 对照最初定义的验收标准：                             │   │
│  │ - [ ] 标准1: [检查结果]                             │   │
│  │ - [ ] 标准2: [检查结果]                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 5.3: 代码质量检查                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Linus 审查清单：                                    │   │
│  │ - [ ] 函数 < 50行                                   │   │
│  │ - [ ] 无 any 类型                                   │   │
│  │ - [ ] 命名准确                                       │   │
│  │ - [ ] 无过度设计                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 5.4: 更新状态文件                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 更新 active_context.md (任务完成)                 │   │
│  │ • 更新 kanban.md (进度100%)                         │   │
│  │ • 写入 decisions.md (重要决策)                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 5.5: 知识沉淀                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 沉淀到 Memory MCP：                                  │   │
│  │ • 新发现的代码模式                                   │   │
│  │ • 踩过的坑（lesson_learned）                        │   │
│  │ • 简化技巧                                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 5.6: 寸止 - 最终确认                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [TASK_DONE]                                         │   │
│  │                                                      │   │
│  │ ## 完成报告                                          │   │
│  │                                                      │   │
│  │ ### TODO 核对                                        │   │
│  │ - [x] T-001 ✅                                       │   │
│  │ - [x] T-002 ✅                                       │   │
│  │                                                      │   │
│  │ ### 验收标准                                         │   │
│  │ - [x] 标准1 ✅                                       │   │
│  │ - [x] 标准2 ✅                                       │   │
│  │                                                      │   │
│  │ ### 变更文件                                         │   │
│  │ - src/types/user.ts (+25)                           │   │
│  │ - src/api/user.ts (+50)                             │   │
│  │                                                      │   │
│  │ 请验收：通过 / 问题 / 优化                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 输出
- TODO 核对报告
- 验收标准检查结果
- 变更文件列表

### 工具
- `verification` — 验证
- `寸止` — 最终确认

### 强制规则
- **必须逐项核对 TODO**
- **必须调用寸止让用户确认**

---

## 📋 状态文件同步

### active_context.md 更新时机

| 阶段 | 更新内容 |
|:---|:---|
| R1 结束 | 需求理解、相关代码位置 |
| I 结束 | 技术方案、数据结构 |
| P 结束 | TODO 列表、执行顺序 |
| E 每项 | 任务完成状态、实际用时 |
| R2 结束 | 最终验收结果 |

### kanban.md 更新时机

| 事件 | 更新 |
|:---|:---|
| TODO 生成 | 添加到「待办」 |
| 任务开始 | 移到「进行中」 |
| 任务完成 | 移到「已完成」 |
| 进度变化 | 更新进度条 |

---

## ⚠️ 强制规则

1. **R1 必须加载 Memory** — 读取用户偏好和禁忌
2. **P 必须生成 TODO** — 无论路径简单还是复杂
3. **E 必须加载 code-simplifier** — 保证代码质量
4. **R2 必须核对 TODO** — 逐项检查完成状态
5. **R2 必须寸止确认** — 让用户验收

---

**版本**: v7.5 | **改进**: 细化每个阶段、强制 TODO 流程 | **核心**: Memory 分离 + 代码简化
