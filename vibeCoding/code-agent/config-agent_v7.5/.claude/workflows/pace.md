# P.A.C.E. Complexity Router (v7.5 Enhanced)

> **核心改进**: 无论简单还是复杂，所有路径都必须生成 TODO 并核对

---

## 🎯 核心原则

```
┌─────────────────────────────────────────────────────────────┐
│                   所有路径必须遵循                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 生成 TODO 列表 (即使只有1项)                            │
│  2. 执行开发流程                                            │
│  3. 根据 TODO 逐项核对                                      │
│  4. 调用寸止与用户确认                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 复杂度评估

### 评估维度

| 维度 | 低(1-3) | 中(4-6) | 高(7-10) |
|:---|:---|:---|:---|
| 文件数量 | 1个 | 2-10个 | >10个 |
| 代码行数 | <30行 | 30-300行 | >300行 |
| 预估时间 | <30分钟 | 30分-4小时 | >4小时 |
| 架构影响 | 无 | 局部 | 全局 |
| 依赖关系 | 无 | 1-3个 | >3个 |

### 评估流程

```javascript
function evaluateComplexity(task) {
  const scores = {
    files: countFiles(task),           // 1-10
    lines: estimateLines(task),        // 1-10
    time: estimateTime(task),          // 1-10
    architecture: assessImpact(task),  // 1-10
    dependencies: countDeps(task)      // 1-10
  };
  
  const total = Object.values(scores).reduce((a, b) => a + b, 0);
  const average = total / 5;
  
  if (average <= 3) return 'Path_A';
  if (average <= 6) return 'Path_B';
  return 'Path_C';
}
```

---

## ⚡ Path A (Simple) - "Quick Fix"

### 条件
- 单文件修改
- <30行代码
- 纯Bug修复、小调整、文档更新
- 无架构影响

### 完整流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Path A 完整流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 1: 生成 TODO                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## TODO                                              │   │
│  │ - [ ] T-001: [任务描述]                              │   │
│  │   - 文件: src/xxx.ts                                │   │
│  │   - 预估: 10分钟                                     │   │
│  │   - 验收: [标准]                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 2: 执行开发                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 加载 code-simplifier                              │   │
│  │ - 执行修改                                          │   │
│  │ - 运行验证                                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 3: TODO 核对                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## TODO 核对                                         │   │
│  │ - [x] T-001: [任务描述] ✅                           │   │
│  │   - 实际: src/xxx.ts (+5/-2)                        │   │
│  │   - 用时: 8分钟                                      │   │
│  │   - 验证: 测试通过                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4: 寸止确认                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [TASK_DONE]                                         │   │
│  │ 修改完成，请确认：通过 / 问题 / 撤销                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 角色加载
- LD (必须)
- code-simplifier (必须)

### 寸止点
- `[TASK_DONE]` - 完成后与用户核对

---

## 🤝 Path B (Medium) - "Plan First"

### 条件
- 2-10个文件
- 新增功能
- 局部重构
- 有少量依赖

### 完整流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Path B 完整流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 1: 需求分析                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ PDM 分析需求，澄清疑点                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 2: 生成 TODO                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## TODO                                              │   │
│  │ - [ ] T-001: 数据模型设计                            │   │
│  │   - 文件: src/types/xxx.ts                          │   │
│  │   - 预估: 30分钟                                     │   │
│  │   - 验收: 类型定义完整                               │   │
│  │                                                      │   │
│  │ - [ ] T-002: 接口实现                                │   │
│  │   - 依赖: T-001                                     │   │
│  │   - 文件: src/api/xxx.ts                            │   │
│  │   - 预估: 1小时                                      │   │
│  │   - 验收: 接口可调用                                 │   │
│  │                                                      │   │
│  │ - [ ] T-003: 前端集成                                │   │
│  │   - 依赖: T-002                                     │   │
│  │   - 文件: src/components/xxx.tsx                    │   │
│  │   - 预估: 1小时                                      │   │
│  │   - 验收: 功能可用                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 3: 寸止 - 计划确认                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [PLAN_READY]                                        │   │
│  │ 计划已生成，请确认：确认 / 修改 / 取消                │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4: 逐项执行                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ For each TODO:                                       │   │
│  │   1. 加载 code-simplifier                           │   │
│  │   2. 执行任务                                        │   │
│  │   3. 运行验证                                        │   │
│  │   4. 标记完成                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 5: TODO 核对                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## TODO 核对                                         │   │
│  │ - [x] T-001: 数据模型设计 ✅                         │   │
│  │ - [x] T-002: 接口实现 ✅                             │   │
│  │ - [x] T-003: 前端集成 ✅                             │   │
│  │                                                      │   │
│  │ 总计: 3/3 完成                                       │   │
│  │ 用时: 2.5小时 (预估: 2.5小时)                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 6: 寸止 - 完成确认                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [TASK_DONE]                                         │   │
│  │ 全部完成，请验收：通过 / 问题 / 继续                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 角色加载
- PDM (需求分析)
- PM (任务规划)
- LD (执行开发)
- code-simplifier (代码简化)

### 寸止点
- `[PLAN_READY]` - 计划确认
- `[TASK_DONE]` - 完成核对

---

## 🏗️ Path C (Hard) - "System Design + Step-by-Step"

### 条件
- >10个文件
- 架构变更
- 从0到1的新系统
- 复杂依赖关系

### 完整流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Path C 完整流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 1: 需求深度分析                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ PDM 召开需求澄清会                                   │   │
│  │ - 第一性原理分析                                     │   │
│  │ - 明确边界和约束                                     │   │
│  │ - 定义验收标准                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 2: 架构设计                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ AR 进行架构设计                                      │   │
│  │ - 加载 thinking skill                               │   │
│  │ - 逐步思考协议                                       │   │
│  │ - Data First: 先定义数据结构                         │   │
│  │ - 方案对比                                          │   │
│  │ - Linus 审查清单                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 3: 寸止 - 设计确认                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [DESIGN_FREEZE]                                     │   │
│  │ 架构设计完成，请选择：方案A / 方案B / 讨论            │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 4: 生成分阶段 TODO                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## Phase 1: 基础架构                                 │   │
│  │ - [ ] T-001: 项目初始化                              │   │
│  │ - [ ] T-002: 数据库设计                              │   │
│  │ - [ ] T-003: 核心模型                                │   │
│  │                                                      │   │
│  │ ## Phase 2: 核心功能                                 │   │
│  │ - [ ] T-004: 用户认证                                │   │
│  │ - [ ] T-005: 主要业务逻辑                            │   │
│  │                                                      │   │
│  │ ## Phase 3: 用户界面                                 │   │
│  │ - [ ] T-006: 页面组件                                │   │
│  │ - [ ] T-007: 交互流程                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 5: 寸止 - 计划确认                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [PLAN_READY]                                        │   │
│  │ 分阶段计划已生成，请确认：确认 / 修改 / 取消          │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 6: 分阶段执行 (循环)                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ For each Phase:                                      │   │
│  │   ┌─────────────────────────────────────────────┐   │   │
│  │   │ 6.1 逐项执行 TODO                            │   │   │
│  │   │ 6.2 加载 code-simplifier                     │   │   │
│  │   │ 6.3 运行验证                                 │   │   │
│  │   │ 6.4 TODO 核对                                │   │   │
│  │   └─────────────────────────────────────────────┘   │   │
│  │                       ↓                              │   │
│  │   ┌─────────────────────────────────────────────┐   │   │
│  │   │ [PHASE_DONE]                                 │   │   │
│  │   │ Phase X 完成，核对结果:                      │   │   │
│  │   │ - [x] T-001 ✅                              │   │   │
│  │   │ - [x] T-002 ✅                              │   │   │
│  │   │ 请确认：继续 / 问题 / 暂停                   │   │   │
│  │   └─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 7: 全量 TODO 核对                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ## 全量 TODO 核对                                    │   │
│  │                                                      │   │
│  │ ### Phase 1 ✅                                       │   │
│  │ - [x] T-001 ✅ | - [x] T-002 ✅ | - [x] T-003 ✅    │   │
│  │                                                      │   │
│  │ ### Phase 2 ✅                                       │   │
│  │ - [x] T-004 ✅ | - [x] T-005 ✅                      │   │
│  │                                                      │   │
│  │ ### Phase 3 ✅                                       │   │
│  │ - [x] T-006 ✅ | - [x] T-007 ✅                      │   │
│  │                                                      │   │
│  │ 总计: 7/7 完成 (100%)                               │   │
│  │ 总用时: 8小时 (预估: 10小时)                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓                                   │
│  Step 8: 寸止 - 最终验收                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [TASK_DONE]                                         │   │
│  │ 项目全部完成，请验收：通过 / 问题 / 优化              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 角色加载
- PDM (需求分析)
- AR (架构设计)
- PM (任务规划)
- LD (执行开发)
- QE (质量检查)
- code-simplifier (代码简化)
- thinking (深度推理)

### 寸止点
- `[DESIGN_FREEZE]` - 架构确认
- `[PLAN_READY]` - 计划确认
- `[PHASE_DONE]` - 每阶段完成
- `[TASK_DONE]` - 最终验收

---

## 📋 TODO 模板

### 标准 TODO 项

```markdown
- [ ] T-XXX: [任务描述]
  - **文件**: [涉及文件]
  - **依赖**: [前置任务ID] 或 无
  - **预估**: [时间]
  - **验收**: [验收标准]
  - **Owner**: [角色]
```

### TODO 核对模板

```markdown
- [x] T-XXX: [任务描述] ✅
  - **实际**: [实际修改的文件] (+行/-行)
  - **用时**: [实际用时]
  - **验证**: [验证结果]
```

---

## 🔄 状态同步

### 写入 active_context.md

```markdown
# Active Context

## 当前阶段
Path: B | Phase: 执行中

## TODO 列表
[TODO 内容]

## 进度
- 总任务: 5
- 已完成: 2
- 进行中: 1
- 待开始: 2

## 最近更新
- [时间] T-002 完成
```

### 写入 kanban.md

```markdown
## 📊 进度

████████░░░░░░░░░░░░ 40% (2/5)

## 看板
[看板内容]
```

---

## ⚠️ 强制规则

1. **所有路径必须生成 TODO** — 即使只有1项
2. **执行后必须核对 TODO** — 逐项检查完成状态
3. **核对后必须寸止** — 等待用户确认
4. **Path C 每阶段都要寸止** — 不能一口气做完

---

**版本**: v7.5 | **改进**: 强制 TODO 生成和核对 | **寸止**: 全路径覆盖
